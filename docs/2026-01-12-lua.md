# Lua 深度代码阅读技能规范

## 研究发现

### 证据表格

| 发现项 | 证据/引用 |
|--------|----------|
| **相关会话** | 找到200+个相关会话，主要在 `dahuaxiyou_checkout` 项目中进行代码分析 |
| **常见问题** | 1. 追踪调用链时容易迷失方向 2. 遇到 `base._xxx` 底层API不知何时停止 3. 服务器交互边界不明确 |
| **变化情况** | 1. 有时从函数入口开始追踪 2. 有时从错误堆栈开始追踪 3. 有时从日志输出开始追踪 |
| **边界情况** | 1. 星火编辑器API (`base._xxx`) 2. 服务器协议处理 (`GS2C`/`C2GS`) 3. Unity原项目对比 |

### 现有技能对比

已有相关技能：
- `legacy-code-bug-fixer`: 修复Bug，包含调用链分析，但目标是修复而非理解
- `debug-info-adder`: 添加调试信息，但不涉及深度阅读
- `sce-api-reference`: 星火API参考，可作为停止边界的参考

**结论**: 需要新技能，专注于"深度阅读理解"而非"修复"或"调试"

---

## 技能设计

### 名称
`lua-deep-reader`

### 描述
深度阅读Lua代码，追踪变量、函数的依赖关系和调用链。当遇到底层API（`base._xxx`）或服务器交互协议时自动停止。用于代码分析、功能理解、架构梳理。

### 触发场景
- 用户说"阅读代码"、"分析代码"、"理解代码"
- 用户说"追踪调用链"、"依赖关系"
- 用户说"这个函数是干什么的"、"这个变量从哪来"

### 核心流程

```
Phase 1: 入口定位
├── 从指定文件/函数开始
├── 或从错误堆栈开始
└── 或从日志输出开始

Phase 2: 递归追踪
├── 向上追踪：谁调用了这个函数
├── 向下追踪：这个函数调用了谁
├── 数据流追踪：变量从哪里来
└── 记录依赖关系图

Phase 3: 边界识别（停止条件）
├── 底层API: base._xxx, self._xxx
├── 服务器协议: GS2C*, C2GS*
├── 引擎API: UnityEngine.*, classtype.*
└── 外部库: 非项目代码

Phase 4: 输出报告
├── 调用关系图
├── 数据流向图
├── 关键函数说明
└── 边界API列表
```

### 停止边界定义

| 边界类型 | 识别模式 | 说明 |
|---------|---------|------|
| 星火底层API | `base._xxx` | 星火编辑器内部实现 |
| 引擎API | `UnityEngine.*` | Unity/星火引擎封装 |
| 服务器协议 | `GS2C*`, `C2GS*` | 客户端-服务器边界 |
| 类型系统 | `classtype.*` | 底层类型定义 |

### 输出格式

```markdown
## 代码阅读报告

### 1. 入口点
- 文件: xxx.lua
- 函数: YYY

### 2. 调用关系图
```
FunctionA (file:line)
  ├─> FunctionB (file:line)
  │     └─> [底层API] base._xxx ← 停止
  └─> FunctionC (file:line)
        └─> [服务器] GS2CXxx ← 停止
```

### 3. 数据流向
- 变量X: 来源 → 处理 → 使用

### 4. 边界API列表
- base._xxx: [说明]
- GS2CXxx: [说明]

### 5. 关键发现
- [重要逻辑说明]
```

### 技能目录结构

```
lua-deep-reader/
├── SKILL.md          # 主技能文件
├── references.md     # 常见边界API参考
└── templates/
    └── report.md     # 报告模板
```

### 位置选择
**Personal** (`C:\Users\unclefata\.factory\skills\`) - 因为这是通用的Lua代码分析技能，可跨项目使用

---

## 与现有技能的配合

```
代码理解 → [lua-deep-reader] 深度阅读
    ↓
发现问题 → [legacy-code-bug-fixer] 修复Bug
    ↓
需要调试 → [debug-info-adder] 添加调试信息
    ↓
查API → [sce-api-reference] 查阅文档
```

---

是否批准创建此技能？