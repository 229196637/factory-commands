---
name: legacy-code-bug-fixer
description: 修复遗留代码中的逻辑Bug。当用户报告代码逻辑错误、运行时异常、功能不符合预期时使用。适用于没有AI辅助时编写的旧代码。
---

# 遗留代码Bug修复

修复之前没有AI辅助时编写的代码中出现的逻辑bug，提供系统化的分析和修复流程。

## 触发场景

- 用户报告代码逻辑错误
- 运行时出现异常或崩溃
- 功能行为不符合预期
- 需要理解和修复旧代码

## 核心原则

1. **深度分析优先** - 不是简单的nil检查，而是理解代码意图和逻辑
2. **方案先行** - 先提供多个修复方案，等用户确认后再执行
3. **影响评估** - 评估修复对现有逻辑的影响
4. **验证闭环** - 修复后验证效果

---

## Phase 1: 问题收集

### 1.1 收集错误信息

```
需要收集的信息：
- 错误日志/堆栈信息
- 错误发生的上下文
- 触发条件和复现步骤
- 预期行为 vs 实际行为
```

### 1.2 定位问题代码

1. 从错误信息中提取关键信息（文件、行号、函数名）
2. 使用 Grep 搜索相关代码
3. 使用 Read 查看完整上下文

---

## Phase 2: 深度分析

### 2.1 调用链分析

```
分析步骤：
1. 找到错误发生点
2. 向上追溯调用链（谁调用了这个函数）
3. 向下追溯数据流（数据从哪里来）
4. 绘制调用关系图
```

### 2.2 代码意图理解

- 阅读函数注释和文档
- 分析函数命名和参数
- 查看相关测试用例
- 对比类似功能的实现

### 2.3 逻辑缺陷识别

**常见逻辑缺陷类型：**

| 类型 | 描述 | 检查方法 |
|------|------|----------|
| 空值问题 | nil/null/undefined 未处理 | 检查所有变量来源 |
| 时序问题 | 异步回调时机不对 | 检查初始化顺序 |
| 边界问题 | 数组越界、循环条件 | 检查边界条件 |
| 状态问题 | 状态机转换错误 | 检查状态流转 |
| 缓存问题 | 缓存命中时同步回调 | 检查缓存逻辑 |
| 类型问题 | 类型转换/比较错误 | 检查类型一致性 |

### 2.4 特殊情况处理

**缺失方法：**
- 搜索原项目（如Unity原项目）查找实现
- 分析方法用途和预期行为
- 决定是实现还是移除调用

**异步问题：**
- 检查回调函数中依赖的变量
- 确认变量在回调前已初始化
- 考虑缓存命中时的同步回调场景

---

## Phase 3: 方案设计

### 3.1 提供多个方案

**必须提供至少2-3个方案：**

```markdown
## 修复方案

### 方案 A: [方案名称]
**描述**: [具体做法]
**优点**: 
- ...
**缺点**: 
- ...
**影响范围**: [会影响哪些功能]

### 方案 B: [方案名称]
**描述**: [具体做法]
**优点**: 
- ...
**缺点**: 
- ...
**影响范围**: [会影响哪些功能]

### 方案 C: [方案名称]（如有）
...

### 推荐方案: [A/B/C]
**理由**: [为什么推荐这个方案]
```

### 3.2 等待用户确认

**重要：在用户明确选择方案之前，不要执行任何代码修改！**

---

## Phase 4: 修复实施

### 4.1 实施修复

1. 按照用户选择的方案修改代码
2. 保持代码风格一致
3. 添加必要的注释说明修复原因

### 4.2 验证修复

- 检查修复是否解决原问题
- 检查是否引入新问题
- 运行相关测试（如有）

---

## 输出格式

### 分析报告

```markdown
## Bug分析报告

### 1. 问题描述
[错误现象和触发条件]

### 2. 根本原因
[为什么会出现这个错误]

### 3. 调用链
```
函数A (文件:行号)
  └─> 函数B (文件:行号)
      └─> 函数C (文件:行号) ← 错误发生点
```

### 4. 修复方案
[方案A/B/C详情]

### 5. 推荐方案
[推荐哪个方案及理由]

请选择方案后回复，我将执行修复。
```

### 修复完成报告

```markdown
## 修复完成

### 修改文件
- `path/to/file.lua`: [修改描述]

### 修复内容
[具体修改了什么]

### 验证结果
[修复是否有效]

### 注意事项
[后续需要注意的问题]
```

---

## 检查清单

在分析过程中，确保检查以下项目：

- [ ] 错误信息已完整收集
- [ ] 调用链已完整追溯
- [ ] 代码原始意图已理解
- [ ] 逻辑缺陷已识别
- [ ] 多个修复方案已准备
- [ ] 方案优缺点已列出
- [ ] 影响范围已评估
- [ ] 用户已确认方案
- [ ] 修复已实施
- [ ] 修复效果已验证
